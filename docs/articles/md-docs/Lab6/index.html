<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/riscvasm.css /><link rel='stylesheet' href=../../../css/makefile.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/MIT-6.S081.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">Lab6</a><ul><li><a href="#h2-1">Uthread: switching between threads</a></li></ul><ul><li><a href="#h2-2">Using threads</a></li></ul><ul><li><a href="#h2-3">Barrier</a></li></ul><ul><li><a href="#h2-4">参考</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">Lab6</h1><blockquote><p><a href="https://pdos.csail.mit.edu/6.828/2022/labs/thread.html" target="_blank">实验文档</a></p></blockquote><p>多线程的实验对应 Chapter 7: Scheduling, 顺序稍有不同, 下一个实验 lab7 对应的是第五章的驱动</p><h2 id="h2-1">Uthread: switching between threads</h2><p>第一个实验的内容是模拟用户态线程的切换, 实验本身已经提供了绝大部分代码, 我们需要完成的是 thread_create thread_schedule 和 user/uthread_switch.S</p><p>首先对于 thread 结构体添加一个字段 context 用于记录上下文寄存器的信息, 这里直接使用 xv6 中的 context 结构体</p><pre class="language-c"><code><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">context</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">ra</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">sp</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token StructDeclaration COMMENT">// callee-saved</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s0</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s1</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s2</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s3</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s4</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s5</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s6</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s7</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s8</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s9</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s10</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">s11</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">thread</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">stack</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="MacroDefine PrimaryExpression Identifier Token TypeSpecifier ID">STACK_SIZE</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE"> </span><span class="Token StructDeclaration COMMENT">/* the thread&#x27;s stack */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">state</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration SPACE">              </span><span class="Token StructDeclaration COMMENT">/* FREE, RUNNING, RUNNABLE */</span><span class="Token StructDeclaration LF">
</span><span class="Token StructDeclaration SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">context</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Identifier TypeSpecifier DirectDeclaractor ID">context</span><span class="Token StructDeclaration SEMI">;</span><span class="Token StructDeclaration LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>然后把 kernel/swtch.S 抄过来</p><pre class="language-riscvasm"><code><span class="Token SPACE">    </span><span class="Token ASM_KEYWORD">.text</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ASM_KEYWORD">.globl</span><span class="Token SPACE"> </span><span class="Token SECTION">thread_switch</span><span class="Token LF">
</span><span class="Token SECTION">thread_switch</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">ra</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">16</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s1</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">24</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s2</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">32</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s3</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">40</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s4</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">48</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s5</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">56</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s6</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">64</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s7</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">72</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s8</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">80</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s9</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">88</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s10</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">96</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">sd</span><span class="Token SPACE"> </span><span class="Token REGISTER">s11</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">104</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a0</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">ra</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">0</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">16</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s1</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">24</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s2</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">32</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s3</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">40</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s4</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">48</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s5</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">56</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s6</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">64</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s7</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">72</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s8</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">80</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s9</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">88</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s10</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">96</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ld</span><span class="Token SPACE"> </span><span class="Token REGISTER">s11</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">104</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">a1</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">    </span><span class="Token ID">ret</span></code></pre><p>在线程创建阶段, 参考 kernel/proc.c 中 allocproc 时的代码</p><pre class="language-c"><code><span class="Token COMMENT">// Set up new context to start executing at forkret,</span><span class="Token LF">
</span><span class="Token COMMENT">// which returns to user space.</span><span class="Token LF">
</span><span class="Token Identifier FunctionCall PrimaryExpression ID">memset</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="UnaryExpression Token Keyword SIZEOF">sizeof</span><span class="UnaryExpression Token CastExpression BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token CastExpression BraceDepth-1 RPAREN">)</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">ra</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token BraceDepth-0 CastExpression ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">forkret</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">sp</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">kstack</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression PLUS">+</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token ExpressionStatement SEMI">;</span></code></pre><p>设置空闲线程 t 的 state 为 RUNNABLE, 然后设置 ra 为回调函数 func 的首地址, 栈指针 sp 为栈的底部</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">thread_create</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token BraceDepth-1 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier FunctionP DirectDeclaractor ID">func</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator RPAREN">)</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator LPAREN">(</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator RPAREN">)</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">thread</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">t</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">t</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">all_thread</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">t</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression LT">&lt;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">all_thread</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token PLUS">+</span><span class="BinaryOp Token SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAX_THREAD</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">state</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">FREE</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">state</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUNNABLE</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">ra</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token CastExpression BraceDepth-1 ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token CastExpression BraceDepth-1 ConditionalExpression RPAREN">)</span><span class="Token Identifier FunctionP PrimaryExpression ID">func</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">sp</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token CastExpression BraceDepth-1 ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token CastExpression BraceDepth-1 ConditionalExpression RPAREN">)</span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">stack</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression PLUS">+</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">STACK_SIZE</span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>最后在调度的时候调用我们写好的 thread_switch 汇编代码, 传入进程的 context 元素位置; 首先将当前的几个寄存器状态保存在 t-&gt;context(原先的线程) 中, 然后将寄存器的值替换为现在将要执行的 current_thread-&gt;context, 接着从 ra 的位置开始执行</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">thread_schedule</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Function Token CompoundStatement COMMENT">// ...</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">current_thread</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">next_thread</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement COMMENT">/* switch threads?  */</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">next_thread</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">state</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">RUNNING</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">t</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">current_thread</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">current_thread</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">next_thread</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">thread_switch</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression RPAREN">)</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">t</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token BraceDepth-0 CastExpression ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression RPAREN">)</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">current_thread</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">context</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement LF">
</span><span class="Token Keyword SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">next_thread</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">uthread</span><span class="Token LF">
</span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token Program ID">thread_c</span><span class="Token SPACE"> </span><span class="Token NUMBER">99</span><span class="Token LF">
</span><span class="Token Program ID">thread_a</span><span class="Token SPACE"> </span><span class="Token NUMBER">99</span><span class="Token LF">
</span><span class="Token Program ID">thread_b</span><span class="Token SPACE"> </span><span class="Token NUMBER">99</span><span class="Token LF">
</span><span class="Token Program ID">thread_c:</span><span class="Token SPACE"> </span><span class="Token ID">exit</span><span class="Token SPACE"> </span><span class="Token ID">after</span><span class="Token SPACE"> </span><span class="Token NUMBER">100</span><span class="Token LF">
</span><span class="Token Program ID">thread_a:</span><span class="Token SPACE"> </span><span class="Token ID">exit</span><span class="Token SPACE"> </span><span class="Token ID">after</span><span class="Token SPACE"> </span><span class="Token NUMBER">100</span><span class="Token LF">
</span><span class="Token Program ID">thread_b:</span><span class="Token SPACE"> </span><span class="Token ID">exit</span><span class="Token SPACE"> </span><span class="Token ID">after</span><span class="Token SPACE"> </span><span class="Token NUMBER">100</span><span class="Token LF">
</span><span class="Token Program ID">thread_schedule:</span><span class="Token SPACE"> </span><span class="Token Fail ID">no</span><span class="Token SPACE"> </span><span class="Token ID">runnable</span><span class="Token SPACE"> </span><span class="Token ID">threads</span></code></pre><h2 id="h2-2">Using threads</h2><p>开始之前先提醒一下, ph.c 的代码存在很严重的内存泄漏, malloc 的都没有释放, 足足 16 * 100000 + 8 * nthread 大小, 笔者是真的难受的要死, 建议运行之前把 free 的代码添加在结尾</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">main</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Function Token CompoundStatement COMMENT">// 加在结尾</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">free</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">tha</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">entry</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">e</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">entry</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">next_e</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement Declaration SEMI">;</span><span class="Token IterationStatement Declaration SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression LT">&lt;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NBUCKET</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token PostfixExpression INC">++</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement BraceDepth-2 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">next_e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">next</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier FunctionCall PrimaryExpression ID">free</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">next_e</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement IterationStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>先了解一下POSIX 线程库提供的两个函数,用于创建多个线程以实现在程序中并发执行多个任务</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">pthread_create</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">thread</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Keyword QualifyType CONST">const</span><span class="Token Keyword QualifyType SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_attr_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">attr</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier FunctionP DirectDeclaractor ID">start_routine</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator RPAREN">)</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token BraceDepth-1 DirectDeclaractor Declarator RPAREN">)</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">arg</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">pthread_join</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">thread</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">retval</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>pthread_create 函数用于创建一个新线程,并将新线程的执行从当前位置开始.它会将新线程的标识符存储在 thread 指针指向的变量中.新线程会执行 start_routine 函数,传入 arg 作为参数.线程的属性可以通过 attr 参数进行设置.</p><ul><li><code>thread</code>: 一个指向 pthread_t 类型变量的指针,用于存储新线程的标识符.</li></ul><ul><li><code>attr</code>: 一个指向 pthread_attr_t 类型的指针,表示线程的属性.可以传入 NULL 来使用默认属性.</li></ul><ul><li><code>start_routine</code>: 一个函数指针,指向新线程要执行的函数.该函数必须返回 void * 类型,接受一个 void * 类型的参数.</li></ul><ul><li><code>arg</code>: 传递给 start_routine 函数的参数.</li></ul><p>pthread_join 函数用于等待指定的线程结束执行.如果线程还在运行,调用该函数的线程会被阻塞,直到指定的线程完成执行.如果传入的 retval 不为 NULL,它会被用来存储线程的返回值.</p><ul><li><code>thread</code>: 要等待的线程的标识符.</li></ul><ul><li><code>retval</code>: 一个指向指针的指针,用于接收线程的返回值.如果不需要线程的返回值,可以传入 NULL.</li></ul><p>多线程出现问题的主要原因就是在 put 函数上, 因为查找 entry 的方式是通过 for 循环遍历, 对于新键通过一个 mod5 的 HASH 找到对应的散列桶然后使用头插法, 因此如果先insert的线程还未返回另一个线程就开始insert那么就会出现数据的缺失</p><pre class="language-c"><code><span class="Token StorageType Keyword FunctionReturnType STATIC">static</span><span class="Token StorageType Keyword FunctionReturnType SPACE"> </span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">put</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">key</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">value</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MOD">%</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NBUCKET</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// is the key already present?</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">entry</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">e</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">next</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">key</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// update the existing key.</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">value</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">value</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// the new is new.</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">insert</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">key</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">value</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>因此只要给 insert 操作上一把锁就可以了</p><pre class="language-c"><code><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_mutex_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">lock</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration LF">
</span><span class="Token StorageType Keyword FunctionReturnType STATIC">static</span><span class="Token StorageType Keyword FunctionReturnType SPACE"> </span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">put</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">key</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">value</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MOD">%</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NBUCKET</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// is the key already present?</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">entry</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">e</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">next</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">key</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// update the existing key.</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">value</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">value</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// the new is new.</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">insert</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">key</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">value</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_unlock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Function Token CompoundStatement LF">
</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">main</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">argc</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">argv</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 LSQUAR_PAREN">[</span><span class="Token DirectDeclaractorPostfix BraceDepth-1 RSQUAR_PAREN">]</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_init</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">lock</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NULL</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token ExpressionStatement COMMENT">// ...</span><span class="Token ExpressionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>或者根据提示为每一个桶上一把锁</p><pre class="language-c"><code><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_mutex_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">lock</span><span class="Token BraceDepth-0 DirectDeclaractorPostfix LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression ID">NBUCKET</span><span class="Token BraceDepth-0 DirectDeclaractorPostfix RSQUAR_PAREN">]</span><span class="Token DirectDeclaractorPostfix SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token InitDeclarator BraceDepth-0 Initializer LCURLY_BRACE">{</span><span class="Token InitDeclarator Initializer SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTHREAD_MUTEX_INITIALIZER</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="Token InitDeclarator BraceDepth-0 Initializer RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token StorageType Keyword FunctionReturnType STATIC">static</span><span class="Token StorageType Keyword FunctionReturnType SPACE"> </span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">put</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">key</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">value</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MOD">%</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">NBUCKET</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Declaration COMMENT">// is the key already present?</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">entry</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">e</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">next</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">key</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">key</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement BREAK">break</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">e</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// update the existing key.</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">e</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">value</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">value</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// the new is new.</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">lock</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">insert</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">key</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">value</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">table</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_unlock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">lock</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><blockquote><p>全局一把锁和每个桶一把锁, 两种方法都可以通过</p></blockquote><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">grade</span><span class="Token SPACE"> </span><span class="Token Variant ID">GRADEFLAGS</span><span class="Token ASSIGN">=</span><span class="Token ID">ph_safe</span><span class="Token LF">
</span><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">grade</span><span class="Token SPACE"> </span><span class="Token Variant ID">GRADEFLAGS</span><span class="Token ASSIGN">=</span><span class="Token ID">ph_fast</span></code></pre><h2 id="h2-3">Barrier</h2><blockquote><p>同样, 先 free(tha);</p></blockquote><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">pthread_cond_wait</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_cond_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">cond</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_mutex_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mutex</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">pthread_cond_broadcast</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pthread_cond_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">cond</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>pthread_cond_wait 函数用于阻塞调用线程,直到条件变量的状态发生变化.为了使用 pthread_cond_wait,通常的做法是先获取一个互斥锁(mutex),然后调用这个函数.函数会将调用线程阻塞,同时释放 mutex,以便其他线程可以访问共享资源.一旦条件变量(cond)发生变化,线程会被唤醒并重新获取 mutex,继续执行.</p><ul><li><code>cond</code>: 指向条件变量的指针.</li></ul><ul><li><code>mutex</code>: 指向互斥锁的指针.</li></ul><p>pthread_cond_broadcast 函数用于广播给定的条件变量,唤醒所有正在等待此条件变量的线程.这允许多个线程同时获得互斥锁并继续执行,通常用于在一组等待线程中选择一个或多个来继续执行,以响应某个事件.</p><p>thread 中的断言条件是 assert(i == t); 也就是说每个线程在调用 barrier 之后都要先停下, 直到所有 n 个线程都调用了 barrier 之后将 round + 1, 然后唤醒所有线程</p><pre class="language-c"><code><span class="Token StorageType Keyword FunctionReturnType STATIC">static</span><span class="Token StorageType Keyword FunctionReturnType SPACE"> </span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">barrier</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_lock</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">barrier_mutex</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">nthread</span><span class="UnaryExpression Token PostfixExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">nthread</span><span class="Token Identifier SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">nthread</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">round</span><span class="UnaryExpression Token PostfixExpression INC">++</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">nthread</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_cond_broadcast</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">barrier_cond</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_cond_wait</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">barrier_cond</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">barrier_mutex</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">pthread_mutex_unlock</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">bstate</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">barrier_mutex</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token Program ID">make</span><span class="Token SPACE"> </span><span class="Token ID">barrier</span><span class="Token LF">
</span><span class="Token Program PATH">./barrier</span><span class="Token SPACE"> </span><span class="Token NUMBER">2</span><span class="Token LF">
</span><span class="Token Program PATH">./barrier</span><span class="Token SPACE"> </span><span class="Token NUMBER">10</span></code></pre><h2 id="h2-4">参考</h2><ul><li><a href="https://zhuanlan.zhihu.com/p/346709521" target="_blank">11.7 XV6线程切换 --- switch函数</a></li></ul><ul><li><a href="https://blog.csdn.net/Edidaughter/article/details/122334074" target="_blank">【CSAPP】背景知识-调用者保存寄存器与被调用者保存寄存器</a></li></ul></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/实验环境搭建" >实验环境搭建</a></li></ul><ul><li><a href="../../md-docs/Lab1" >Lab1</a></li></ul><ul><li><a href="../../md-docs/Lab2" >Lab2</a></li></ul><ul><li><a href="../../md-docs/Lab3" >Lab3</a></li></ul><ul><li><a href="../../md-docs/Lab4" >Lab4</a></li></ul><ul><li><a href="../../md-docs/Lab5" >Lab5</a></li></ul><ul><li><a href="../../md-docs/Lab6" >Lab6</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/Lab5",".","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>