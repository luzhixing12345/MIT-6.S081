<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/riscvasm.css /><link rel='stylesheet' href=../../../css/makefile.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/MIT-6.S081.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">Lab5</a><ul><li><a href="#h2-1">Implement copy-on-write fork</a></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">Lab5</h1><blockquote><p><a href="https://pdos.csail.mit.edu/6.828/2022/labs/cow.html" target="_blank">实验文档</a></p></blockquote><p>lab5 只有这一个实验, 实现写时复制, 本章没有对应任何一个章节, 算是对于前面页表和中断知识点的总结复习</p><h2 id="h2-1">Implement copy-on-write fork</h2><p>在 kernel/defs.h 添加两个函数声明, 分别用于判断当前页面是否是一个写时复制的页面, 以及去分配一个写时分配的页面</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE">             </span><span class="FunctionName Token Identifier DirectDeclaractor ID">is_cow_page</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pagetable</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">va</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Typedefine Keyword FunctionReturnType Token TypeSpecifier TYPEDEF_ID">uint64</span><span class="Typedefine Keyword FunctionReturnType Token TypeSpecifier SPACE">          </span><span class="FunctionName Token Identifier DirectDeclaractor ID">alloc_cow_page</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pagetable</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">va</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>在 kernel/kalloc.c 中声明两个全局变量, 分别用于记录所有物理页的引用数量, 以及一个锁</p><pre class="language-c"><code><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">page_reference</span><span class="Token BraceDepth-0 DirectDeclaractorPostfix LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression ID">PHYSTOP</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token BraceDepth-0 DirectDeclaractorPostfix RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">spinlock</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reference_count_lock</span><span class="Token Declaration SEMI">;</span></code></pre><p>修正 kfree 和 kalloc, 对于需要释放的页面 pa, 将其对应的 page_reference 引用数减一, 如果剩余引用数 &lt;= 0, 则释放页面并加入到空闲链表中. 这里需要注意两个地方, 一个是锁reference_count_lock的释放时机, 在完成对于 page_reference 的操作即释放, 不要嵌套 acquire; 第二个是引用判断条件是 <code>&lt;= 0</code> , 因为在系统运行开始的时候,需要对空闲页列表 (kmem.freelist) 进行初始化,此时的引用计数就为 -1</p><p>对于 kalloc, 初始化 page_reference 设置为 1 即可</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">kfree</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pa</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">run</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">r</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="BinaryOp Token BraceDepth-0 CastExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="BinaryOp Token BraceDepth-0 CastExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MOD">%</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token NE">!=</span><span class="BinaryOp Token SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression OR">||</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="BinaryOp Token CastExpression BraceDepth-2 LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="BinaryOp Token CastExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token LT">&lt;</span><span class="BinaryOp Token SPACE"> </span><span class="Token Identifier PrimaryExpression ID">end</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression OR">||</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="BinaryOp Token CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="BinaryOp Token CastExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token GE">&gt;=</span><span class="BinaryOp Token SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PHYSTOP</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">panic</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;kfree&quot;</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">acquire</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">page_reference</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LSQUAR_PAREN">[</span><span class="BinaryOp Token CastExpression BraceDepth-2 LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="BinaryOp Token CastExpression BraceDepth-2 RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression SUB_ASSIGN">-=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">page_reference</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="BinaryOp Token BraceDepth-0 CastExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="BinaryOp Token BraceDepth-0 CastExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression LE">&lt;=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">release</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token ExpressionStatement COMMENT">// Fill with junk to catch dangling refs.</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">memset</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token BraceDepth-2 CastExpression ConditionalExpression LPAREN">(</span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">run</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token BraceDepth-2 CastExpression ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">acquire</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">r</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">next</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">freelist</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">freelist</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">release</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">release</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement LF">
</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="FunctionName Token Identifier DirectDeclaractor ID">kalloc</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">run</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">r</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">acquire</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">freelist</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">freelist</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">r</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">next</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">acquire</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">page_reference</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="BinaryOp Token BraceDepth-0 CastExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="BinaryOp Token BraceDepth-0 CastExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">release</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">release</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">kmem</span><span class="UnaryExpression Token PostfixExpression DOT">.</span><span class="Token Identifier ID">lock</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">memset</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token BraceDepth-2 CastExpression ConditionalExpression LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token BraceDepth-2 CastExpression ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">5</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement SPACE">  </span><span class="Token ExpressionStatement SelectionStatement COMMENT">// fill with junk</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token CastExpression BraceDepth-1 ConditionalExpression LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token CastExpression BraceDepth-1 ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">r</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>接下来看一下标志位, sv39 和 sv32 的标志位含义相同, 如下图所示</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230809092832.png" alt="20230809092832"></p><ul><li>V 位表示 PTE 是否有效. 如果 V 为 0,则 PTE 中的所有其他位都是无关位,软件可以自由使用.</li></ul><ul><li>权限位 R、W 和 X 分别表示页面是否可读、可写和可执行. <b>当这三个位都为零时,PTE 是指向页表下一级的指针;否则,它就是叶 PTE.</b></li></ul><ul><li><b>可写页面也必须标记为可读;相反的组合则保留留作将来使用</b>. 下图概述了 X/W/R 的组合情况<p>其中 <code>000</code> 代表 1级/2级页表, <code>010</code> 和 <code>110</code> 中 W/R 并没有统一, 留作后期使用</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230809092813.png" alt="20230809092813"></p></li></ul><ul><li>U 位表示页面是否可由用户模式访问.U 模式软件只有在 U=1 时才能访问页面.</li></ul><ul><li>G 位表示全局映射.全局映射是指存在于所有地址空间中的映射.对于非叶 PTE,全局设置意味着页表后续级别中的所有映射都是全局映射.表中的所有映射都是全局映射.<blockquote><p>暂未使用</p></blockquote></li></ul><ul><li>RSW 字段保留给监控软件使用;执行时应忽略该字段</li></ul><ul><li>每个叶 PTE 包含一个已访问 (A) 位和一个脏 (D) 位.A 位表示虚拟页面在上次清除 A 位后被读取、写入或获取.D 位表示自上次清除 D 位后,虚拟页面已被写入.<blockquote><p>在 Lab3 Detect which pages have been accessed 实验中被使用过</p></blockquote></li></ul><ul><li>试图从没有执行权限的页面获取指令时,会引发获取页面故障异常.</li></ul><ul><li>试图执行有效地址位于无读取权限页面内的加载或加载保留指令,会引发加载页面故障异常.</li></ul><ul><li>试图执行有效地址位于无写入权限页面内的存储、存储条件或 AMO 指令,会引发存储页面故障异常.</li></ul><ul><li>AMO 不会引发加载页面故障异常.因为任何不可读页面也是不可写页面、</li></ul><ul><li>试图在不可读页面上执行 AMO 时,总是会引发存储页面故障异常.</li></ul><p>所以我们可以使用 RSW 字段, 这里我们使用第八位, 若为 1 则说明为 COW 页面. 在 kernel/riscv.h 中定义宏 PTE_COW</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword ControlLine Preprocess DEFINE">define</span><span class="Token Keyword ControlLine Preprocess SPACE"> </span><span class="Token Identifier MacroDefine ControlLine ID">PTE_COW</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken BraceDepth-0 LPAREN">(</span><span class="Token PPtoken NUMBER">1L</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken SHL">&lt;&lt;</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken NUMBER">8</span><span class="Token PPtoken BraceDepth-0 RPAREN">)</span><span class="Token PPtoken SPACE"> </span><span class="Token PPtoken COMMENT">// copy on write</span></code></pre><p><a href="https://github.com/riscv/riscv-isa-manual/releases/download/Priv-v1.12/riscv-privileged-20211203.pdf" target="_blank">riscv-privileged-20211203.pdf</a> 4.1.9 中标注了 scause 值为 15 时对应 AMO 页错误的情况</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230809163412.png" alt="20230809163412"></p><p>在 kernel/trap.c 中添加一个条件判断, 对于 15 号中断信号获取其 va 地址, 然后做一些判断, 调用 alloc_cow_page 分配页面, 如果分配失败则设置 killed 标志位为 1</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier VOID">void</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">usertrap</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Function Token CompoundStatement COMMENT">// ...</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">scause</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">r_scause</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">scause</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">8</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// system call</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">scause</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">15</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">va</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">r_stval</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">va</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression GE">&gt;=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">sz</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">killed</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier FunctionCall PrimaryExpression ID">alloc_cow_page</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">killed</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">which_dev</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">devintr</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement COMMENT">// ok</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">printf</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;usertrap(): unexpected scause </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> pid=</span><span class="Format Token String STRING">%d</span><span class="Token String Control STRING">\n</span><span class="Token String STRING">&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">r_scause</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">pid</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">printf</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;            sepc=</span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> stval=</span><span class="Format Token String STRING">%p</span><span class="Token String Control STRING">\n</span><span class="Token String STRING">&quot;</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">r_sepc</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">r_stval</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">setkilled</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement SelectionStatement COMMENT">// ...</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>接下来的所有函数修改均在 kernel/vm.c, 引入前面定义的东西</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Token Keyword ControlLine Preprocess INCLUDE">include</span><span class="Token Keyword ControlLine Preprocess SPACE"> </span><span class="Token String HeaderName STRING">&quot;spinlock.h&quot;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Token Keyword ControlLine Preprocess INCLUDE">include</span><span class="Token Keyword ControlLine Preprocess SPACE"> </span><span class="Token String HeaderName STRING">&quot;proc.h&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token StorageType Keyword EXTERN">extern</span><span class="Token StorageType Keyword SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType INT">int</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">page_reference</span><span class="Token BraceDepth-0 DirectDeclaractorPostfix LSQUAR_PAREN">[</span><span class="Token Identifier MacroDefine PrimaryExpression ID">PHYSTOP</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token BraceDepth-0 DirectDeclaractorPostfix RSQUAR_PAREN">]</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token StorageType Keyword EXTERN">extern</span><span class="Token StorageType Keyword SPACE"> </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">spinlock</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">reference_count_lock</span><span class="Token Declaration SEMI">;</span></code></pre><p>首先对于具有写权限 <code>PTE_W</code> 的页面取消其写权限, 并添加 <code>PTE_COW</code> 标记为写时复制页面, 加锁并更新页面的引用数量. 最后将新页面的页表直接映射为旧页面的 pa. 此时 fork 的两个父子进程具有相同的页表信息</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">uvmcopy</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">old</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">new</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">sz</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pte_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pte</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pa</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">i</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword FOR">for</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression LT">&lt;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">sz</span><span class="Token IterationStatement SEMI">;</span><span class="Token IterationStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ADD_ASSIGN">+=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">walk</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">old</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier FunctionCall PrimaryExpression ID">panic</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;uvmcopy: pte should exist&quot;</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_V</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier FunctionCall PrimaryExpression ID">panic</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token String STRING">&quot;uvmcopy: page not present&quot;</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE2PA</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token PPtoken MUL">*</span><span class="Token Identifier ID">pte</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_W</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression XOR_ASSIGN">^=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_W</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">            </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression OR_ASSIGN">|=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_COW</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">acquire</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">page_reference</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="BinaryOp Token BraceDepth-0 CastExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="BinaryOp Token BraceDepth-0 CastExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ADD_ASSIGN">+=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">release</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp AMPERSAND">&amp;</span><span class="Token Identifier PrimaryExpression ID">reference_count_lock</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_FLAGS</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token PPtoken MUL">*</span><span class="Token Identifier ID">pte</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier FunctionCall PrimaryExpression ID">mappages</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">new</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token CastExpression BraceDepth-1 ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token CastExpression BraceDepth-1 ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression NE">!=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement GOTO">goto</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier JumpStatement GotoLabel ID">err</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token Identifier GotoLabel LabeledStatement ID">err</span><span class="Token LabeledStatement COLON">:</span><span class="Token LabeledStatement LF">
</span><span class="Token LabeledStatement SPACE">    </span><span class="Token Identifier FunctionCall PrimaryExpression ID">uvmunmap</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">new</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">i</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement LabeledStatement SEMI">;</span><span class="Token ExpressionStatement LabeledStatement LF">
</span><span class="Token ExpressionStatement LabeledStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="UnaryExpression Token UnaryOp MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>判断页面是否是 cow 只需要判断 PTE_V 和 PTE_COW 两个标志位. 分配页面 alloc_cow_page 要麻烦一些, 首先拿到 pte 和 pa, 接下来判断如果当前 pa 的页面引用为 1, 则说明没有其他进程含有对该页面的引用了, 则当前进程可以直接使用这个页面, 修改 pte 的标志位, 设置 PTE_W 以及取消 PTE_COW</p><p>如果还有其他页面具有对该页面的引用, 则使用 kalloc 分配一个新页面, 将页面复制过去之后释放掉当前页面(这里的释放不是指真的释放, 而是减一个对于页面的引用), 通过 <code>PA2PTE(mem)</code> 使用新页面的 pte 修改当前页面的 pte 值, 添加 PTE_W 去掉 PTE_COW, 返回新分配的页地址 mem</p><blockquote><p>这里需要注意的是 if (va &gt;= MAXVA) 这个判断条件要有, 不然 unittest 的时候会因为 va 的参数导致 panic walk 失败</p></blockquote><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">is_cow_page</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pagetable</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">va</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pte_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pte</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">walk</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_V</span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AND">&amp;&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_COW</span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement LF">
</span><span class="Typedefine Keyword FunctionReturnType Token TypeSpecifier TYPEDEF_ID">uint64</span><span class="Typedefine Keyword FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">alloc_cow_page</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pagetable</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">va</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">mem</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">va</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression GE">&gt;=</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">MAXVA</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pte_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pte</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">walk</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pa</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">walkaddr</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="UnaryExpression Token UnaryOp MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_COW</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token EQ">==</span><span class="BinaryOp Token SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression OR">||</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_U</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token EQ">==</span><span class="BinaryOp Token SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token Constant PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression OR">||</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression AMPERSAND">&amp;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_V</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token EQ">==</span><span class="BinaryOp Token SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="UnaryExpression Token UnaryOp MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">    </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token BraceDepth-1 SelectionStatement LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">page_reference</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LSQUAR_PAREN">[</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression DIV">/</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RSQUAR_PAREN">]</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token BraceDepth-1 SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression OR_ASSIGN">|=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_W</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression XOR_ASSIGN">^=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_COW</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement SPACE"> </span><span class="Token Keyword SelectionStatement ELSE">else</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mem</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">kalloc</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token PrimaryExpression PostfixExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="UnaryExpression Token UnaryOp MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">memmove</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">mem</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token BraceDepth-0 CastExpression ConditionalExpression LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">kfree</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">pa</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">flags</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_FLAGS</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token PPtoken MUL">*</span><span class="Token Identifier ID">pte</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="Token Identifier MacroDefine PrimaryExpression ID">PA2PTE</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token Identifier ID">mem</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="BinaryOp Token ConditionalExpression PIPE">|</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">flags</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression PIPE">|</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_W</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression XOR_ASSIGN">^=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PTE_COW</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token BraceDepth-2 CastExpression ConditionalExpression LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token BraceDepth-2 CastExpression ConditionalExpression RPAREN">)</span><span class="Token Identifier PrimaryExpression ID">mem</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="Token CompoundStatement BraceDepth-1 SelectionStatement RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>最后对于 copyout, 当从内核空间复制到用户空间, 用户空间的地址 dstva 所在的 va0 也可能是一个写时复制的共享页面, 因此需要判断一下对于有效的页面, 如果是一个 COW 页面, 则调用 alloc_cow_page 分配一个新页面替换掉之前的 pa0</p><pre class="language-c"><code><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier INT">int</span><span class="Keyword BaseType FunctionReturnType Token TypeSpecifier SPACE"> </span><span class="FunctionName Token Identifier DirectDeclaractor ID">copyout</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator LPAREN">(</span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pagetable_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pagetable</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">dstva</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token TypeSpecifier Keyword BaseType CHAR">char</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">src</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">len</span><span class="Token BraceDepth-0 DirectDeclaractor Declarator RPAREN">)</span><span class="Token DirectDeclaractor Declarator SPACE"> </span><span class="Function Token CompoundStatement BraceDepth-0 LCURLY_BRACE">{</span><span class="Function Token CompoundStatement LF">
</span><span class="Function Token CompoundStatement SPACE">    </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">uint64</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">n</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">va0</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token Identifier DirectDeclaractor ID">pa0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="IterationStatement Token Keyword WHILE">while</span><span class="IterationStatement Token Keyword SPACE"> </span><span class="Token IterationStatement BraceDepth-1 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression GT">&gt;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token IterationStatement BraceDepth-1 RPAREN">)</span><span class="Token IterationStatement SPACE"> </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 LCURLY_BRACE">{</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGROUNDDOWN</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token Identifier ID">dstva</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">pa0</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">walkaddr</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pa0</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="UnaryExpression Token UnaryOp MINUS">-</span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SelectionStatement SEMI">;</span><span class="Token JumpStatement SelectionStatement LF">
</span><span class="Token JumpStatement SelectionStatement SPACE">        </span><span class="Structure StructureType Keyword Token TypeSpecifier STRUCT">struct</span><span class="Structure StructureType Keyword Token TypeSpecifier SPACE"> </span><span class="Structure StructureClass Identifier Token TypeSpecifier ID">proc</span><span class="Structure StructureClass Identifier Token TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">p</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">myproc</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Typedefine Keyword TypeSpecifier TYPEDEF_ID">pte_t</span><span class="Token Typedefine Keyword TypeSpecifier SPACE"> </span><span class="Token Pointer Declarator POINTER">*</span><span class="Token Identifier DirectDeclaractor ID">pte</span><span class="Token Identifier DirectDeclaractor SPACE"> </span><span class="Token InitDeclarator ASSIGN">=</span><span class="Token InitDeclarator SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">walk</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="UnaryExpression Token UnaryOp POINTER">*</span><span class="Token Identifier PrimaryExpression ID">pte</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression EQ">==</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">p</span><span class="UnaryExpression Token PostfixExpression POINT">-&gt;</span><span class="Token Identifier ID">killed</span><span class="Token Identifier SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">1</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier FunctionCall PrimaryExpression ID">is_cow_page</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 LCURLY_BRACE">{</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">pa0</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier FunctionCall PrimaryExpression ID">alloc_cow_page</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pagetable</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="UnaryExpression Token BraceDepth-0 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token CompoundStatement SelectionStatement BraceDepth-2 RCURLY_BRACE">}</span><span class="Token CompoundStatement SelectionStatement LF">
</span><span class="Token CompoundStatement SelectionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">n</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token Identifier MacroDefine PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MINUS">-</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">dstva</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MINUS">-</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="Token BraceDepth-2 PrimaryExpression PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Keyword SelectionStatement IF">if</span><span class="Token Keyword SelectionStatement SPACE"> </span><span class="Token SelectionStatement BraceDepth-2 LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">n</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression GT">&gt;</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token SelectionStatement BraceDepth-2 RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">            </span><span class="Token Identifier PrimaryExpression ID">n</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token ExpressionStatement SelectionStatement SEMI">;</span><span class="Token ExpressionStatement SelectionStatement LF">
</span><span class="Token ExpressionStatement SelectionStatement SPACE">        </span><span class="Token Identifier FunctionCall PrimaryExpression ID">memmove</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression LPAREN">(</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression LPAREN">(</span><span class="Token TypeSpecifier Keyword BaseType VOID">void</span><span class="Token TypeSpecifier Keyword BaseType SPACE"> </span><span class="Token Pointer AbstractDeclarator POINTER">*</span><span class="Token BraceDepth-0 CastExpression ConditionalExpression RPAREN">)</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">pa0</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression PLUS">+</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression LPAREN">(</span><span class="Token Identifier PrimaryExpression ID">dstva</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression MINUS">-</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="Token PrimaryExpression BraceDepth-1 PostfixExpression RPAREN">)</span><span class="Token BraceDepth-0 PrimaryExpression PostfixExpression RPAREN">)</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">src</span><span class="UnaryExpression Token PostfixExpression COMMA">,</span><span class="UnaryExpression Token PostfixExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">n</span><span class="UnaryExpression Token BraceDepth-2 PostfixExpression RPAREN">)</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">len</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression SUB_ASSIGN">-=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">n</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">src</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ADD_ASSIGN">+=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">n</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">        </span><span class="Token Identifier PrimaryExpression ID">dstva</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="AssignOp Token AssignmentExpression ASSIGN">=</span><span class="AssignOp Token AssignmentExpression SPACE"> </span><span class="Token Identifier PrimaryExpression ID">va0</span><span class="Token Identifier PrimaryExpression SPACE"> </span><span class="BinaryOp Token ConditionalExpression PLUS">+</span><span class="BinaryOp Token ConditionalExpression SPACE"> </span><span class="Token Identifier MacroDefine PrimaryExpression ID">PGSIZE</span><span class="Token ExpressionStatement SEMI">;</span><span class="Token ExpressionStatement LF">
</span><span class="Token ExpressionStatement SPACE">    </span><span class="Token CompoundStatement IterationStatement BraceDepth-1 RCURLY_BRACE">}</span><span class="Token CompoundStatement IterationStatement LF">
</span><span class="Token CompoundStatement IterationStatement SPACE">    </span><span class="Token Keyword JumpStatement RETURN">return</span><span class="Token Keyword JumpStatement SPACE"> </span><span class="Token Constant PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function Token CompoundStatement BraceDepth-0 RCURLY_BRACE">}</span></code></pre><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">cowtest</span><span class="Token LF">
</span><span class="Token Program ID">simple:</span><span class="Token SPACE"> </span><span class="Token Success ID">ok</span><span class="Token LF">
</span><span class="Token Program ID">simple:</span><span class="Token SPACE"> </span><span class="Token Success ID">ok</span><span class="Token LF">
</span><span class="Token Program ID">three:</span><span class="Token SPACE"> </span><span class="Token Success ID">ok</span><span class="Token LF">
</span><span class="Token Program ID">three:</span><span class="Token SPACE"> </span><span class="Token Success ID">ok</span><span class="Token LF">
</span><span class="Token Program ID">three:</span><span class="Token SPACE"> </span><span class="Token Success ID">ok</span><span class="Token LF">
</span><span class="Token Program ID">file:</span><span class="Token SPACE"> </span><span class="Token Success ID">ok</span><span class="Token LF">
</span><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Token Program ID">usertests</span><span class="Token SPACE"> </span><span class="Token OPTION">-q</span><span class="Token LF">
</span><span class="Token Program ID">...</span><span class="Token LF">
</span><span class="Token Program ID">ALL</span><span class="Token SPACE"> </span><span class="Token ID">TESTS</span><span class="Token SPACE"> </span><span class="Token Success ID">PASSED</span></code></pre></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/实验环境搭建" >实验环境搭建</a></li></ul><ul><li><a href="../../md-docs/Lab1" >Lab1</a></li></ul><ul><li><a href="../../md-docs/Lab2" >Lab2</a></li></ul><ul><li><a href="../../md-docs/Lab3" >Lab3</a></li></ul><ul><li><a href="../../md-docs/Lab4" >Lab4</a></li></ul><ul><li><a href="../../md-docs/Lab5" >Lab5</a></li></ul><ul><li><a href="../../md-docs/Lab6" >Lab6</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/Lab4","../../md-docs/Lab6","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>