<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        Document
    </title>
    <link rel='stylesheet' href=../../../css/index.css />
    <link rel='stylesheet' href=../../../css/c.css /><link rel='stylesheet' href=../../../css/json.css /><link rel='stylesheet' href=../../../css/makefile.css /><link rel='stylesheet' href=../../../css/shell.css /><link rel='stylesheet' href=../../../css/riscvasm.css />
    <link rel="icon" href="https://raw.githubusercontent.com/learner-lu/picbed/master/logo.png">
</head>

<body class="light">
    <a href="https://github.com/luzhixing12345/MIT-6.S081.git" target="_blank" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>
    <div class="header-navigator"><ul><li><a href="#h1-0">Lab4</a><ul><li><a href="#h2-1">RISC-V assembly</a></li></ul><ul><li><a href="#h2-2">Backtrace</a></li></ul><ul><li><a href="#h2-3">Alarm</a><ul><li><a href="#h3-4">test0</a></li></ul><ul><li><a href="#h3-5">完整实现</a></li></ul></li></ul></li></ul></div><div class='markdown-body'><h1 id="h1-0">Lab4</h1><blockquote><p><a href="https://pdos.csail.mit.edu/6.828/2022/labs/traps.html" target="_blank">实验文档</a></p></blockquote><pre class="language-shell"><code><span class="Program Token ID">git</span><span class="Token SPACE"> </span><span class="Token ID">checkout</span><span class="Token SPACE"> </span><span class="Token ID">traps</span><span class="Token LF">
</span><span class="Program Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">clean</span></code></pre><h2 id="h2-1">RISC-V assembly</h2><p>第一个实验的要求是阅读 RISCV 的汇编代码, 内容相对比较简单, 下面直接给出答案</p><pre class="language-shell"><code><span class="Program Token ID">make</span><span class="Token SPACE"> </span><span class="Token ID">fs.img</span></code></pre><p>user/call.c 相关代码如下</p><pre class="language-c"><code><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType INT">int</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">g</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">x</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">  </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Identifier Token PrimaryExpression ID">x</span><span class="Token ConditionalExpression BinaryOp PLUS">+</span><span class="Constant Token PrimaryExpression NUMBER">3</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType INT">int</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">f</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">x</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">  </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="FunctionName Identifier Token PrimaryExpression ID">g</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Identifier Token ID">x</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">main</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">  </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> </span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="FunctionName Identifier Token PrimaryExpression ID">f</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="PPtoken Token NUMBER">8</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token ConditionalExpression BinaryOp PLUS">+</span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">13</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">  </span><span class="Identifier FunctionCall Token PrimaryExpression ID">exit</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>汇编结果如下</p><pre class="language-riscvasm"><code><span class="Token NUMBER">0000000000000000</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token ID">g</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">int</span><span class="Token SPACE"> </span><span class="Token ID">g</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">0</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">1141</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">2</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">e422</span><span class="Token SPACE">                    </span><span class="Token ID">sd</span><span class="Token SPACE">  </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token NUMBER">8</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token REGISTER">sp</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">4</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0800</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">return</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token PLUS">+</span><span class="Token NUMBER">3</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">6</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">250d</span><span class="Token SPACE">                    </span><span class="Token ID">addiw</span><span class="Token SPACE">   </span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token NUMBER">8</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">6422</span><span class="Token SPACE">                    </span><span class="Token ID">ld</span><span class="Token SPACE">  </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">sp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token SECTION">a</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0141</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token SECTION">c</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">8082</span><span class="Token SPACE">                    </span><span class="Token ID">ret</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000000e</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token ID">f</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">int</span><span class="Token SPACE"> </span><span class="Token ID">f</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">int</span><span class="Token SPACE"> </span><span class="Token ID">x</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">   </span><span class="Token SECTION">e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">1141</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">10</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">e422</span><span class="Token SPACE">                    </span><span class="Token ID">sd</span><span class="Token SPACE">  </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token NUMBER">8</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token REGISTER">sp</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">12</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0800</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">return</span><span class="Token SPACE"> </span><span class="Token ID">g</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token ID">x</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">14</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">250d</span><span class="Token SPACE">                    </span><span class="Token ID">addiw</span><span class="Token SPACE">   </span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token NUMBER">3</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">16</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">6422</span><span class="Token SPACE">                    </span><span class="Token ID">ld</span><span class="Token SPACE">  </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token NUMBER">8</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token REGISTER">sp</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">18</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0141</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1a</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">8082</span><span class="Token SPACE">                    </span><span class="Token ID">ret</span><span class="Token LF">
</span><span class="Token NUMBER">000000000000001c</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LANGLE_BRACE">&lt;</span><span class="Token ID">main</span><span class="Token BraceDepth-0 RANGLE_BRACE">&gt;</span><span class="Token COLON">:</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Token ID">void</span><span class="Token SPACE"> </span><span class="Token ID">main</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token ID">void</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1c</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">1141</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token MINUS">-</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">1e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">e406</span><span class="Token SPACE">                    </span><span class="Token ID">sd</span><span class="Token SPACE">  </span><span class="Token REGISTER">ra</span><span class="Token COMMA">,</span><span class="Token NUMBER">8</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token REGISTER">sp</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">20</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">e022</span><span class="Token SPACE">                    </span><span class="Token ID">sd</span><span class="Token SPACE">  </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token NUMBER">0</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token REGISTER">sp</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">22</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">0800</span><span class="Token SPACE">                    </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">s0</span><span class="Token COMMA">,</span><span class="Token REGISTER">sp</span><span class="Token COMMA">,</span><span class="Token NUMBER">16</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">printf</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> </span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token ID">f</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Token NUMBER">8</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="Token PLUS">+</span><span class="Token NUMBER">1</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token NUMBER">13</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">24</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">4635</span><span class="Token SPACE">                    </span><span class="Token ID">li</span><span class="Token SPACE">  </span><span class="Token REGISTER">a2</span><span class="Token COMMA">,</span><span class="Token NUMBER">13</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">26</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">45b1</span><span class="Token SPACE">                    </span><span class="Token ID">li</span><span class="Token SPACE">  </span><span class="Token REGISTER">a1</span><span class="Token COMMA">,</span><span class="Token NUMBER">12</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">28</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">00000517</span><span class="Token SPACE">            </span><span class="Token ID">auipc</span><span class="Token SPACE">   </span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token NUMBER">0x0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">2c</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">7b850513</span><span class="Token SPACE">            </span><span class="Token ID">addi</span><span class="Token SPACE">    </span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token NUMBER">1976</span><span class="Token SPACE"> </span><span class="Token COMMENT"># 7e0 &lt;malloc+0xe6&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">30</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">00000097</span><span class="Token SPACE">            </span><span class="Token ID">auipc</span><span class="Token SPACE">   </span><span class="Token REGISTER">ra</span><span class="Token COMMA">,</span><span class="Token NUMBER">0x0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">34</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">612080e7</span><span class="Token SPACE">            </span><span class="Token ID">jalr</span><span class="Token SPACE">    </span><span class="Token NUMBER">1554</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token REGISTER">ra</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token COMMENT"># 642 &lt;printf&gt;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token ID">exit</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token NUMBER">0</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token SEMI">;</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">38</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">4501</span><span class="Token SPACE">                    </span><span class="Token ID">li</span><span class="Token SPACE">  </span><span class="Token REGISTER">a0</span><span class="Token COMMA">,</span><span class="Token NUMBER">0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3a</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">00000097</span><span class="Token SPACE">            </span><span class="Token ID">auipc</span><span class="Token SPACE">   </span><span class="Token REGISTER">ra</span><span class="Token COMMA">,</span><span class="Token NUMBER">0x0</span><span class="Token LF">
</span><span class="Token SPACE">  </span><span class="Token NUMBER">3e</span><span class="Token COLON">:</span><span class="Token SPACE">   </span><span class="Token NUMBER">28e080e7</span><span class="Token SPACE">            </span><span class="Token ID">jalr</span><span class="Token SPACE">    </span><span class="Token NUMBER">654</span><span class="BraceDepth-1 Token LPAREN">(</span><span class="Token REGISTER">ra</span><span class="BraceDepth-1 Token RPAREN">)</span><span class="Token SPACE"> </span><span class="Token COMMENT"># 2c8 &lt;exit&gt;</span></code></pre><p><b>Q1: Which registers contain arguments to functions? For example, which register holds 13 in main&#x27;s call to printf?</b></p><p>riscv 使用通用寄存器 a0 - a7, 多余参数保存在栈中</p><p>代码中一共出现了四次函数调用, 分别是 printf f g exit, 可以看到 0x24 使用 a2 寄存器保存了 13, 编译器将 f(8) + 1 的函数调用和运算直接进行优化在编译期计算得到 12 并使用 a1 保存, 0x38 处使用 a0 保存 exit 的参数 0</p><p><b>Q2: Where is the call to function f in the assembly code for main? Where is the call to g?</b></p><p>main 的汇编代码没有调用 f 和 g 函数.编译器对其进行了优化</p><p><b>Q3: At what address is the function printf located?</b></p><p><code>0x642 &lt;printf&gt;</code></p><p><b>Q4: What value is in the register ra just after the jalr to printf in main?</b></p><p><code>0x38</code></p><p><b>Q5: What is the output? The output depends on that fact that the RISC-V is little-endian. If the RISC-V were instead big-endian what would you set i to in order to yield the same output? Would you need to change 57616 to a different value?</b></p><p>可以创建一个文件 user/a.c 并加入 Makefile, 在其中执行, 输出结果为 &quot;HE110 World&quot;</p><pre class="language-c"><code><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName Token String STRING">&quot;kernel/param.h&quot;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName Token String STRING">&quot;kernel/types.h&quot;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName Token String STRING">&quot;kernel/stat.h&quot;</span><span class="Token LF">
</span><span class="Token HASH">#</span><span class="Preprocess ControlLine Keyword Token INCLUDE">include</span><span class="Preprocess ControlLine Keyword Token SPACE"> </span><span class="HeaderName Token String STRING">&quot;user/user.h&quot;</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType INT">int</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">main</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token UNSIGNED">unsigned</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">i</span><span class="DirectDeclaractor Identifier Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0x00646c72</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;H</span><span class="Format Token String STRING">%x</span><span class="Token String STRING"> Wo</span><span class="Format Token String STRING">%s</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">57616</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">i</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>57616 使用 %x 输出 16 进制为 <code>0xe110</code>. 小端存储的 i 低字节在低地址处, 使用 %s 将其作为字符串输出, 0x72 0x6c 0x64 对应的 ASCII 字符分别为 r l d, 所以最终结果为 <code>HE110 World</code>. 大端存储则修改 i 值为 <code>0x726c6400</code>, 无论 57616 在大端序还是小端序,它的二进制值都为 e110 .大端序和小端序只是改变了多字节数据在内存中的存放方式,并不改变其真正的值的大小,所以 57616 始终打印为二进制 e110</p><p><b>In the following code, what is going to be printed after &#x27;y=&#x27;?</b></p><pre class="language-c"><code><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;x=</span><span class="Format Token String STRING">%d</span><span class="Token String STRING"> y=</span><span class="Format Token String STRING">%d</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">3</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span></code></pre><p>不确定, 由 a1 寄存器调用之前的值决定</p><h2 id="h2-2">Backtrace</h2><p>第二个实验的任务是完成对于函数调用栈的信息输出</p><p>在 kernel/defs.h 声明 backtrace</p><pre class="language-c"><code><span class="Token COMMENT">// printf.c</span><span class="Token LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE">            </span><span class="DirectDeclaractor Identifier FunctionName Token ID">printf</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token CHAR">char</span><span class="Pointer Declarator Token POINTER">*</span><span class="Token COMMA">,</span><span class="Token SPACE"> </span><span class="Token VARARGS">...</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE">            </span><span class="DirectDeclaractor Identifier FunctionName Token ID">panic</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token CHAR">char</span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="GNU_C_Assembly Token DirectDeclaractor _ATTRIBUTE">__attribute__</span><span class="GNU_C_Assembly Token BraceDepth-0 DirectDeclaractor LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token PrimaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">noreturn</span><span class="PostfixExpression BraceDepth-1 Token PrimaryExpression RPAREN">)</span><span class="GNU_C_Assembly Token BraceDepth-0 DirectDeclaractor RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE">            </span><span class="DirectDeclaractor Identifier FunctionName Token ID">printfinit</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE">            </span><span class="DirectDeclaractor Identifier FunctionName Token ID">backtrace</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="Token Declaration SEMI">;</span></code></pre><p>在 kernel/riscv.h 中定义 r_fp</p><pre class="language-c"><code><span class="FunctionReturnType StorageType Keyword Token STATIC">static</span><span class="FunctionReturnType StorageType Keyword Token SPACE"> </span><span class="FunctionReturnType FunctionType Keyword Token INLINE">inline</span><span class="FunctionReturnType FunctionType Keyword Token SPACE"> </span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token TYPEDEF_ID">uint64</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token LF">
</span><span class="DirectDeclaractor Identifier FunctionName Token ID">r_fp</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">  </span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">x</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">  </span><span class="GNU_C_Assembly Keyword Token ASM">asm</span><span class="GNU_C_Assembly Keyword Token SPACE"> </span><span class="GNU_C_Assembly Keyword Token VOLATILE">volatile</span><span class="GNU_C_Assembly BraceDepth-1 Token LPAREN">(</span><span class="Token String STRING">&quot;mv </span><span class="Format Token String STRING">%0</span><span class="Token String STRING">, s0&quot;</span><span class="Token SPACE"> </span><span class="GNU_C_Assembly Token COLON">:</span><span class="GNU_C_Assembly Token SPACE"> </span><span class="GNU_C_Assembly Token STRING">&quot;=r&quot;</span><span class="GNU_C_Assembly Token SPACE"> </span><span class="GNU_C_Assembly Token BraceDepth-2 LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">x</span><span class="GNU_C_Assembly Token BraceDepth-2 RPAREN">)</span><span class="GNU_C_Assembly Token SPACE"> </span><span class="GNU_C_Assembly BraceDepth-1 Token RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">  </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Identifier Token PrimaryExpression ID">x</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>在 kernel/sysproc.c 的 sys_sleep 中调用 backtrace</p><pre class="language-c"><code><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token TYPEDEF_ID">uint64</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">sys_sleep</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">n</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">ticks0</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">backtrace</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">argint</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">n</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">n</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp LT">&lt;</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Identifier Token PrimaryExpression ID">n</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SelectionStatement SEMI">;</span><span class="ExpressionStatement Token SelectionStatement LF">
</span><span class="ExpressionStatement Token SelectionStatement SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">acquire</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">tickslock</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">ticks0</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">ticks</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token IterationStatement WHILE">while</span><span class="Keyword Token IterationStatement SPACE"> </span><span class="IterationStatement Token BraceDepth-1 LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">ticks</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token BinaryOp MINUS">-</span><span class="Token BinaryOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">ticks0</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp LT">&lt;</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">n</span><span class="IterationStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement Token SPACE"> </span><span class="CompoundStatement IterationStatement Token BraceDepth-1 LCURLY_BRACE">{</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="CompoundStatement IterationStatement Token SPACE">        </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-2 Token SelectionStatement LPAREN">(</span><span class="Identifier FunctionCall Token PrimaryExpression ID">killed</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression LPAREN">(</span><span class="Identifier FunctionCall Token PrimaryExpression ID">myproc</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression RPAREN">)</span><span class="BraceDepth-2 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-2 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">            </span><span class="Identifier FunctionCall Token PrimaryExpression ID">release</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">tickslock</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="UnaryOp Token UnaryExpression MINUS">-</span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">        </span><span class="CompoundStatement BraceDepth-2 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Identifier FunctionCall Token PrimaryExpression ID">sleep</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">ticks</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">tickslock</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement IterationStatement Token BraceDepth-1 RCURLY_BRACE">}</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="CompoundStatement IterationStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">release</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">tickslock</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>在 kernel/printf.c 中实现 backtrace</p><pre class="language-c"><code><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">backtrace</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">fp</span><span class="DirectDeclaractor Identifier Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_fp</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Keyword Token IterationStatement WHILE">while</span><span class="Keyword Token IterationStatement SPACE"> </span><span class="IterationStatement Token BraceDepth-1 LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">fp</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp NE">!=</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Identifier Token PrimaryExpression MacroDefine ID">PGROUNDDOWN</span><span class="Token BraceDepth-2 LPAREN">(</span><span class="Identifier Token ID">fp</span><span class="Token BraceDepth-2 RPAREN">)</span><span class="IterationStatement Token BraceDepth-1 RPAREN">)</span><span class="IterationStatement Token SPACE"> </span><span class="CompoundStatement IterationStatement Token BraceDepth-1 LCURLY_BRACE">{</span><span class="CompoundStatement IterationStatement Token SPACE">       </span><span class="CompoundStatement IterationStatement Token COMMENT">// 判断触底</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="CompoundStatement IterationStatement Token SPACE">        </span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">ra</span><span class="DirectDeclaractor Identifier Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="UnaryOp Token UnaryExpression POINTER">*</span><span class="CastExpression UnaryOp Token BraceDepth-2 LPAREN">(</span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression UnaryOp Token BraceDepth-2 RPAREN">)</span><span class="PostfixExpression BraceDepth-2 Token PrimaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">fp</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp MINUS">-</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">8</span><span class="PostfixExpression BraceDepth-2 Token PrimaryExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration SPACE">  </span><span class="Token Declaration COMMENT">// return address</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">        </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;</span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">ra</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">        </span><span class="Identifier Token PrimaryExpression ID">fp</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="UnaryOp Token UnaryExpression POINTER">*</span><span class="CastExpression UnaryOp Token BraceDepth-2 LPAREN">(</span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression UnaryOp Token BraceDepth-2 RPAREN">)</span><span class="PostfixExpression BraceDepth-2 Token PrimaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">fp</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp MINUS">-</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">16</span><span class="PostfixExpression BraceDepth-2 Token PrimaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token SPACE">  </span><span class="ExpressionStatement Token COMMENT">// previous fp</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="CompoundStatement IterationStatement Token BraceDepth-1 RCURLY_BRACE">}</span><span class="CompoundStatement IterationStatement Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>RISCV 的函数调用栈如下所示, 其中 fp 为当前栈帧, fp-8 保存着返回地址, fp-16 保存着上一个栈帧的位置, 因此首先使用 r_fp 拿到当前 bracetrace 函数的栈帧, 接着打印返回地址 ra 的值, 并将 fp 置为前一个栈帧 fp-16 位置的值, 如此循环. 使用 PGROUNDDOWN 来判断是否触底</p><p><img src="https://raw.githubusercontent.com/learner-lu/picbed/master/20230808153053.png" alt="20230808153053"></p><blockquote><p><a href="https://pdos.csail.mit.edu/6.1810/2022/lec/l-riscv.txt" target="_blank">lecture notes</a></p></blockquote><p>运行结果如下, 使用 addr2line 可以对应调用行数</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Program Token ID">bttest</span><span class="Token LF">
</span><span class="Token NUMBER">0x000000008000212e</span><span class="Token LF">
</span><span class="Token NUMBER">0x0000000080002020</span><span class="Token LF">
</span><span class="Token NUMBER">0x0000000080001d16</span></code></pre><pre class="language-shell"><code><span class="Token BraceDepth-0 LPAREN">(</span><span class="Program Token ID">base</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token HOST_NAME">kamilu@LZX</span><span class="Token COLON">:</span><span class="Token DIR_PATH">~/xv6</span><span class="Token TAG"></span><span class="Token SPACE"> </span><span class="Program Token ID">addr2line</span><span class="Token SPACE"> </span><span class="Token OPTION">-e</span><span class="Token SPACE"> </span><span class="Token PATH">kernel/kernel</span><span class="Token LF">
</span><span class="Token NUMBER">0x000000008000212e</span><span class="Token LF">
</span><span class="Program Token PATH">/home/kamilu/xv6-labs-2022/kernel/sysproc.c:47</span><span class="Token LF">
</span><span class="Token NUMBER">0x0000000080002020</span><span class="Token LF">
</span><span class="Program Token PATH">/home/kamilu/xv6-labs-2022/kernel/syscall.c:141</span><span class="Token LF">
</span><span class="Token NUMBER">0x0000000080001d16</span><span class="Token LF">
</span><span class="Program Token PATH">/home/kamilu/xv6-labs-2022/kernel/trap.c:76</span></code></pre><blockquote><p>顺便可以加入到 panic 之中在异常之时打印函数调用栈</p></blockquote><h2 id="h2-3">Alarm</h2><p>最后一个实验的要求是添加两个系统调用, 用于定时记录进程的运行时间.</p><blockquote><p>添加系统调用的方式同前面相同, 这里不再赘述</p></blockquote><h3 id="h3-4">test0</h3><p>我们先来看一下比较简单的 test0, 实现 alarm 的基础功能. 首先在 kernel/proc.h 为 proc 结构体添加三个元素, 分别记录时间间隔 interval, 已经经过的时间 passed_ticks, 和需要执行的函数 handler</p><pre class="language-c"><code><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">spinlock</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">lock</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="StructDeclaration Token COMMENT">// p-&gt;lock must be held when using these:</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier EnumSpecifier Keyword Token ENUM">enum</span><span class="TypeSpecifier EnumSpecifier Keyword Token SPACE"> </span><span class="EnumSpecifier TypeSpecifier Identifier Token EnumID ID">procstate</span><span class="EnumSpecifier TypeSpecifier Identifier Token EnumID SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">state</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">  </span><span class="StructDeclaration Token COMMENT">// Process state</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">chan</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">            </span><span class="StructDeclaration Token COMMENT">// If non-zero, sleeping on chan</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">killed</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">            </span><span class="StructDeclaration Token COMMENT">// If non-zero, have been killed</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">xstate</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">            </span><span class="StructDeclaration Token COMMENT">// Exit status to be returned to parent&#x27;s wait</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">pid</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token SPACE">               </span><span class="StructDeclaration Token COMMENT">// Process ID</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">interval</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">passed_ticks</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Declarator BraceDepth-1 Token LPAREN">(</span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor FunctionP TypeSpecifier Identifier Token ID">handler</span><span class="DirectDeclaractor Declarator BraceDepth-1 Token RPAREN">)</span><span class="DirectDeclaractor Declarator BraceDepth-1 Token LPAREN">(</span><span class="DirectDeclaractor Declarator BraceDepth-1 Token RPAREN">)</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>kernel/proc.c 在进程初始化和释放的过程中完成初始化和收尾工作.</p><pre class="language-c"><code><span class="FunctionReturnType StorageType Keyword Token STATIC">static</span><span class="FunctionReturnType StorageType Keyword Token SPACE"> </span><span class="StructureType TypeSpecifier FunctionReturnType Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier FunctionReturnType Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier FunctionReturnType Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier FunctionReturnType Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier FunctionName Token ID">allocproc</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Function CompoundStatement Token COMMENT">// ...</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-1 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression BraceDepth-1 Token ConditionalExpression RPAREN">)</span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// ...</span><span class="ExpressionStatement Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token LF">
</span><span class="FunctionReturnType StorageType Keyword Token STATIC">static</span><span class="FunctionReturnType StorageType Keyword Token SPACE"> </span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">freeproc</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier Token ID">p</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Function CompoundStatement Token COMMENT">// ...</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// ...</span><span class="ExpressionStatement Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>在 kernel/sysproc.c 的 sys_sigalarm 中读取参数完成对于 p 的赋值</p><pre class="language-c"><code><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token TYPEDEF_ID">uint64</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">sys_sigalarm</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">interval</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">handler</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">argint</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">interval</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">argaddr</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">handler</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier Token ID">p</span><span class="DirectDeclaractor Identifier Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">myproc</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">interval</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-1 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression BraceDepth-1 Token ConditionalExpression RPAREN">)</span><span class="Identifier Token PrimaryExpression ID">handler</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token LF">
</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token TYPEDEF_ID">uint64</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">sys_sigreturn</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>程序执行执行系统调用后返回到用户空间的完整过程如下</p><ul><li>ecall指令中将PC保存到SEPC</li></ul><ul><li>在usertrap中将SEPC保存到p-&gt;trapframe-&gt;epc</li></ul><ul><li>p-&gt;trapframe-&gt;epc加4指向下一条指令</li></ul><ul><li>执行系统调用</li></ul><ul><li>在usertrapret中将SEPC改写为p-&gt;trapframe-&gt;epc中的值</li></ul><ul><li>在sret中将PC设置为SEPC的值</li></ul><p>因此需要在 kernel/trap.c 中修改 usertrap, 对于 devintr 返回值为 2, 即定时器中断的情况. 首先检查是否设置了时间间隔, 若是, 则将 passed_ticks + 1, 检查是否到达. 将当前进程 trapframe 的 epc 值设置为当前需要执行的 handler 的地址, 结束时间片中断后由此处开始继续执行</p><pre class="language-c"><code><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_scause</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp EQ">==</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">8</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="CompoundStatement Token SelectionStatement COMMENT">// ...</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token PrimaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">which_dev</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">devintr</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-1 Token PrimaryExpression RPAREN">)</span><span class="PostfixExpression Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp NE">!=</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="CompoundStatement Token SelectionStatement COMMENT">// ok</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">which_dev</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp EQ">==</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">2</span><span class="BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-2 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="Token ConditionalExpression BinaryOp NE">!=</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="BraceDepth-2 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-2 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">            </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ADD_ASSIGN">+=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="Token ConditionalExpression BinaryOp EQ">==</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">                </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">trapframe</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">epc</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-1 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="CastExpression BraceDepth-1 Token ConditionalExpression RPAREN">)</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">                </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="CompoundStatement BraceDepth-2 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;usertrap(): unexpected scause </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> pid=</span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_scause</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">pid</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;            sepc=</span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> stval=</span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_sepc</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_stval</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">setkilled</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span></code></pre><p>至此就可以成功通过 test0 了, 但是注意到其余 test 均失败了</p><pre class="language-shell"><code><span class="Token VARIANT">$</span><span class="Token SPACE"> </span><span class="Program Token ID">alarmtest</span><span class="Token LF">
</span><span class="Program Token ID">test0</span><span class="Token SPACE"> </span><span class="Token ID">start</span><span class="Token LF">
</span><span class="Program Token ID">.........alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">test0</span><span class="Token SPACE"> </span><span class="Success Token ID">passed</span><span class="Token LF">
</span><span class="Program Token ID">test1</span><span class="Token SPACE"> </span><span class="Token ID">start</span><span class="Token LF">
</span><span class="Program Token ID">.alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">.alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">..alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">..alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">..alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">..alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">...alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">.alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">.alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Program Token ID">..alarm</span><span class="Token BANG">!</span><span class="Token LF">
</span><span class="Token LF">
</span><span class="Program Token ID">test1</span><span class="Token SPACE"> </span><span class="Fail Token ID">failed:</span><span class="Token SPACE"> </span><span class="Function Token ID">foo</span><span class="Token BraceDepth-0 LPAREN">(</span><span class="Token BraceDepth-0 RPAREN">)</span><span class="Token SPACE"> </span><span class="Token ID">executed</span><span class="Token SPACE"> </span><span class="Token ID">fewer</span><span class="Token SPACE"> </span><span class="Token ID">times</span><span class="Token SPACE"> </span><span class="Token ID">than</span><span class="Token SPACE"> </span><span class="Token ID">it</span><span class="Token SPACE"> </span><span class="Token ID">was</span><span class="Token SPACE"> </span><span class="Token ID">called</span><span class="Token LF">
</span><span class="Token TEXT">�</span><span class="Token String STRING">&quot;�usertrap(): unexpected scause 0x000000000000000c pid=3
            sepc=0x0000000000014f50 stval=0x0000000000014f50&quot;</span></code></pre><h3 id="h3-5">完整实现</h3><p>要解决的主要问题是寄存器保存恢复和防止重复执行的问题. 因为此时我们设置了 <code>p-&gt;trapframe-&gt;epc = (uint64)p-&gt;handler</code>, 从处理函数handler的地址开始继续执行, 而handler可能会改变用户寄存器</p><p>所以要在usertrap中再次保存用户寄存器,当handler调用sigreturn时将其恢复,并且要防止在handler执行过程中重复调用</p><p>添加 alarm_trapframe 用于保存当前陷阱帧状态, 以及 is_alarming 用于判断当前是否已经有了正在判断的正</p><pre class="language-c"><code><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Structure Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="Structure Token COMMENT">// ...</span><span class="Structure Token LF">
</span><span class="Structure Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">interval</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">passed_ticks</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Declarator BraceDepth-1 Token LPAREN">(</span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor FunctionP TypeSpecifier Identifier Token ID">handler</span><span class="DirectDeclaractor Declarator BraceDepth-1 Token RPAREN">)</span><span class="DirectDeclaractor Declarator BraceDepth-1 Token LPAREN">(</span><span class="DirectDeclaractor Declarator BraceDepth-1 Token RPAREN">)</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">trapframe</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">alarm_trapframe</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier TypeSpecifier Token ID">is_alarming</span><span class="StructDeclaration Token SEMI">;</span><span class="StructDeclaration Token LF">
</span><span class="StructDeclaration Token SPACE">    </span><span class="StructDeclaration Token COMMENT">// ...</span><span class="StructDeclaration Token LF">
</span><span class="Structure Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Token Declaration SEMI">;</span></code></pre><p>完成对于 alarm_trapframe 和 is_alarming 的初始化和释放, 注意对于 trapframe 采用 kalloc 和 kfree 进行分配与释放</p><pre class="language-c"><code><span class="FunctionReturnType StorageType Keyword Token STATIC">static</span><span class="FunctionReturnType StorageType Keyword Token SPACE"> </span><span class="StructureType TypeSpecifier FunctionReturnType Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier FunctionReturnType Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier FunctionReturnType Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier FunctionReturnType Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier FunctionName Token ID">allocproc</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Function CompoundStatement Token COMMENT">// ...</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="PostfixExpression BraceDepth-2 Token PrimaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">alarm_trapframe</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-0 Token ConditionalExpression LPAREN">(</span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">trapframe</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression BraceDepth-0 Token ConditionalExpression RPAREN">)</span><span class="Identifier FunctionCall Token PrimaryExpression ID">kalloc</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-0 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-2 Token PrimaryExpression RPAREN">)</span><span class="PostfixExpression Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp EQ">==</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Identifier FunctionCall Token PrimaryExpression ID">release</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">lock</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">        </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Token JumpStatement SPACE">    </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-1 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression BraceDepth-1 Token ConditionalExpression RPAREN">)</span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">is_alarming</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// ...</span><span class="ExpressionStatement Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Function CompoundStatement Token LF">
</span><span class="FunctionReturnType StorageType Keyword Token STATIC">static</span><span class="FunctionReturnType StorageType Keyword Token SPACE"> </span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType VOID">void</span><span class="TypeSpecifier FunctionReturnType Keyword Token BaseType SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">freeproc</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier Token ID">p</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Function CompoundStatement Token COMMENT">// ...</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">alarm_trapframe</span><span class="BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement LF">
</span><span class="Token SelectionStatement SPACE">        </span><span class="Identifier FunctionCall Token PrimaryExpression ID">kfree</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="CastExpression BraceDepth-2 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression BraceDepth-2 Token ConditionalExpression RPAREN">)</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">alarm_trapframe</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SelectionStatement SEMI">;</span><span class="ExpressionStatement Token SelectionStatement LF">
</span><span class="ExpressionStatement Token SelectionStatement SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">alarm_trapframe</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">is_alarming</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="ExpressionStatement Token COMMENT">// ...</span><span class="ExpressionStatement Token LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre><p>trap.c 中在条件判断中增加 <code>!p-&gt;is_alarming</code> 用于确定当前没有其他 alarm 影响, 不然会导致重复覆盖 alarm_trapframe 页面. 接着使用 memmove 将 trapframe 页面复制到 alarm_trapframe 做备份, 后将 trapframe 的 epc 设置为 handler 的地址开始执行.</p><pre class="language-c"><code><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_scause</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp EQ">==</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">8</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="CompoundStatement Token SelectionStatement COMMENT">// ...</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token PrimaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">which_dev</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">devintr</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-1 Token PrimaryExpression RPAREN">)</span><span class="PostfixExpression Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp NE">!=</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="CompoundStatement Token SelectionStatement COMMENT">// ok</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-1 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">which_dev</span><span class="Identifier Token PrimaryExpression SPACE"> </span><span class="Token ConditionalExpression BinaryOp EQ">==</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">2</span><span class="BraceDepth-1 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-2 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="Token ConditionalExpression BinaryOp NE">!=</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="BraceDepth-2 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-2 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">            </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ADD_ASSIGN">+=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="Keyword Token SelectionStatement IF">if</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="BraceDepth-0 Token SelectionStatement LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="Token BinaryOp EQ">==</span><span class="Token BinaryOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="Token ConditionalExpression BinaryOp AND">&amp;&amp;</span><span class="Token ConditionalExpression BinaryOp SPACE"> </span><span class="UnaryOp Token UnaryExpression BANG">!</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">is_alarming</span><span class="BraceDepth-0 Token SelectionStatement RPAREN">)</span><span class="Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">                </span><span class="Identifier FunctionCall Token PrimaryExpression ID">memmove</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">alarm_trapframe</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">trapframe</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Keyword Token UnaryExpression SIZEOF">sizeof</span><span class="CastExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">trapframe</span><span class="CastExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">                </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">trapframe</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">epc</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-1 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="CastExpression BraceDepth-1 Token ConditionalExpression RPAREN">)</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">                </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">                </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">is_alarming</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">            </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">        </span><span class="CompoundStatement BraceDepth-2 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="CompoundStatement BraceDepth-1 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span><span class="CompoundStatement Token SelectionStatement SPACE"> </span><span class="Keyword Token SelectionStatement ELSE">else</span><span class="Keyword Token SelectionStatement SPACE"> </span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement LCURLY_BRACE">{</span><span class="CompoundStatement Token SelectionStatement LF">
</span><span class="CompoundStatement Token SelectionStatement SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;usertrap(): unexpected scause </span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> pid=</span><span class="Format Token String STRING">%d</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_scause</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">pid</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">printf</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Token String STRING">&quot;            sepc=</span><span class="Format Token String STRING">%p</span><span class="Token String STRING"> stval=</span><span class="Format Token String STRING">%p</span><span class="Control Token String STRING">\n</span><span class="Token String STRING">&quot;</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_sepc</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">r_stval</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="PostfixExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">setkilled</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="CompoundStatement BraceDepth-0 Token SelectionStatement RCURLY_BRACE">}</span></code></pre><p>系统调用中 sys_sigalarm 没有变化, sys_sigreturn 将 trapframe 通过 alarm_trapframe 进行恢复, 情况 is_alarming, 返回值设置为先前 trapframe 的 a0</p><pre class="language-c"><code><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token TYPEDEF_ID">uint64</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">sys_sigalarm</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="TypeSpecifier BaseType Keyword Token INT">int</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">interval</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="TypeSpecifier Typedefine Keyword Token TYPEDEF_ID">uint64</span><span class="TypeSpecifier Typedefine Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier Token ID">handler</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">argint</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">interval</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">argaddr</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Constant Token PrimaryExpression NUMBER">1</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="UnaryOp Token UnaryExpression AMPERSAND">&amp;</span><span class="Identifier Token PrimaryExpression ID">handler</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier Token ID">p</span><span class="DirectDeclaractor Identifier Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">myproc</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">interval</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Identifier Token PrimaryExpression ID">interval</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">handler</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="CastExpression BraceDepth-1 Token ConditionalExpression LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="TypeSpecifier BaseType Keyword Token SPACE"> </span><span class="Pointer AbstractDeclarator Token POINTER">*</span><span class="CastExpression BraceDepth-1 Token ConditionalExpression RPAREN">)</span><span class="Identifier Token PrimaryExpression ID">handler</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">passed_ticks</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token LF">
</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token TYPEDEF_ID">uint64</span><span class="Typedefine TypeSpecifier FunctionReturnType Keyword Token SPACE"> </span><span class="DirectDeclaractor Identifier FunctionName Token ID">sys_sigreturn</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 LPAREN">(</span><span class="TypeSpecifier BaseType Keyword Token VOID">void</span><span class="DirectDeclaractor Declarator Token BraceDepth-0 RPAREN">)</span><span class="DirectDeclaractor Declarator Token SPACE"> </span><span class="Function CompoundStatement Token BraceDepth-0 LCURLY_BRACE">{</span><span class="Function CompoundStatement Token LF">
</span><span class="Function CompoundStatement Token SPACE">    </span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">proc</span><span class="StructureClass TypeSpecifier Identifier Token Structure SPACE"> </span><span class="Pointer Declarator Token POINTER">*</span><span class="DirectDeclaractor Identifier Token ID">p</span><span class="DirectDeclaractor Identifier Token SPACE"> </span><span class="InitDeclarator Token ASSIGN">=</span><span class="InitDeclarator Token SPACE"> </span><span class="Identifier FunctionCall Token PrimaryExpression ID">myproc</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="Token Declaration SEMI">;</span><span class="Token Declaration LF">
</span><span class="Token Declaration SPACE">    </span><span class="Identifier FunctionCall Token PrimaryExpression ID">memmove</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression LPAREN">(</span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">trapframe</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">alarm_trapframe</span><span class="PostfixExpression Token UnaryExpression COMMA">,</span><span class="PostfixExpression Token UnaryExpression SPACE"> </span><span class="Keyword Token UnaryExpression SIZEOF">sizeof</span><span class="CastExpression Token BraceDepth-2 UnaryExpression LPAREN">(</span><span class="StructureType TypeSpecifier Keyword Token Structure STRUCT">struct</span><span class="StructureType TypeSpecifier Keyword Token Structure SPACE"> </span><span class="StructureClass TypeSpecifier Identifier Token Structure ID">trapframe</span><span class="CastExpression Token BraceDepth-2 UnaryExpression RPAREN">)</span><span class="PostfixExpression BraceDepth-1 Token UnaryExpression RPAREN">)</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">is_alarming</span><span class="Identifier Token SPACE"> </span><span class="AssignmentExpression Token AssignOp ASSIGN">=</span><span class="AssignmentExpression Token AssignOp SPACE"> </span><span class="Constant Token PrimaryExpression NUMBER">0</span><span class="ExpressionStatement Token SEMI">;</span><span class="ExpressionStatement Token LF">
</span><span class="ExpressionStatement Token SPACE">    </span><span class="Keyword Token JumpStatement RETURN">return</span><span class="Keyword Token JumpStatement SPACE"> </span><span class="Identifier Token PrimaryExpression ID">p</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">trapframe</span><span class="PostfixExpression Token UnaryExpression POINT">-&gt;</span><span class="Identifier Token ID">a0</span><span class="Token JumpStatement SEMI">;</span><span class="Token JumpStatement LF">
</span><span class="Function CompoundStatement Token BraceDepth-0 RCURLY_BRACE">}</span></code></pre></div>
    <div class="dir-tree"><ul><li><a href="../../md-docs/README" >README</a></li></ul><ul><li><a href="../../md-docs/实验环境搭建" >实验环境搭建</a></li></ul><ul><li><a href="../../md-docs/Lab1" >Lab1</a></li></ul><ul><li><a href="../../md-docs/Lab2" >Lab2</a></li></ul><ul><li><a href="../../md-docs/Lab3" >Lab3</a></li></ul><ul><li><a href="../../md-docs/Lab4" >Lab4</a></li></ul></div>
    <div class="zood"><a class="" href="https://github.com/luzhixing12345/zood" target="_blank">zood</a></div>
    <script type="text/javascript" src="../../../js/next_front.js"></script><script>addLink("../../md-docs/Lab3",".","ab")</script><script type="text/javascript" src="../../../js/change_mode.js"></script><script>addChangeModeButton("../../../img/sun.png","../../../img/moon.png")</script><script type="text/javascript" src="../../../js/copy_code.js"></script><script>addCodeCopy("../../../img/before_copy.png","../../../img/after_copy.png")</script><script type="text/javascript" src="../../../js/navigator.js"></script><script type="text/javascript" src="../../../js/picture_preview.js"></script><script type="text/javascript" src="../../../js/global_js_configuration.js"></script>
</body>

</html>